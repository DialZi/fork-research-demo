pipeline{
  agent any
  tools {
    maven 'Maven'
  }

  environment {
        DEFECT_DOJO_ENGAGEMENT_ID = '6'
        DEFECT_DOJO_IP = 'http://172.16.1.4:8081'
        DEFECT_DOJO_KEY = credentials('defectDojoApiKey')
        JAVA_PROJECT_NAME= 'demoProject-0.0.1'
        JENKINS_PROJECT_NAME = 'demo'
        DEPENDENCY_CHECK_URL = 'https://raw.githubusercontent.com/domi810/demo/master/owasp-dependency-check.sh'
    }
  stages{


      stage ('Static Tests'){
        parallel{
                stage ('SCA') {

        steps {
          //remove file if exists
         sh 'rm owasp* || true'
         //get newest script
         sh 'wget ${DEPENDENCY_CHECK_URL}'
         //make executable
         sh 'chmod +x owasp-dependency-check.sh'
         //run script
         sh 'bash owasp-dependency-check.sh'
         //cat for testing
         sh 'cat /home/jenkins/workspace/${JENKINS_PROJECT_NAME}/dependency-check-report.xml'
         ///upload to defect dojo
         sh 'curl -X POST "${DEFECT_DOJO_IP}/api/v2/import-scan/"  -H "Authorization: Token ${DEFECT_DOJO_KEY}"  -H  "accept: application/json" -H   "Content-Type: multipart/form-data" -F "minimum_severity=Info" -F "active=true" -F "verified=true" -F "scan_type=Dependency Check Scan" -F "file=@/home/jenkins/workspace/${JENKINS_PROJECT_NAME}/dependency-check-report.xml;type=text/xml" -F "engagement=${DEFECT_DOJO_ENGAGEMENT_ID}" -F "close_old_findings=false" -F "push_to_jira=false"'
      }
    }

      stage ('SAST') {
            steps {
              withSonarQubeEnv('sonarserver') {
                sh 'mvn sonar:sonar'
                sh 'cat target/sonar/report-task.txt'
              }
            }
        }
        }
      }



    stage ('Build'){
        steps{
          sh 'mvn clean package'
        }
    }
    stage ('DAST'){
      steps{
        //stop test container if already started
        sh 'docker container stop apptest || true'
        //create network
        sh 'docker network create zapnet || true'
        //start docker with the test war. make sure folder is owned by same uid as user zap in docker
        sh 'docker run --net zapnet -d -p 8085:8080 --rm -v /home/jenkins/workspace/${JENKINS_PROJECT_NAME}/target/${JAVA_PROJECT_NAME}.war:/usr/local/tomcat/webapps/${JAVA_PROJECT_NAME}.war --name apptest tomcat'
        //make sure app is runnig
        sleep(time:5,unit:"SECONDS")
        //run zap docker. go on on error
        sh 'docker run --net zapnet --rm -v $(pwd)/zap:/zap/wrk:rw  -t owasp/zap2docker-stable zap-full-scan.py -t http://apptest:8080/${JAVA_PROJECT_NAME}/ -g gen.conf -x zap_report.xml || true'
        //upload to defect dojo
        sh 'curl -X POST "${DEFECT_DOJO_IP}/api/v2/import-scan/"  -H "Authorization: Token ${DEFECT_DOJO_KEY}"  -H  "accept: application/json" -H   "Content-Type: multipart/form-data" -F "minimum_severity=Info" -F "active=true" -F "verified=true" -F "scan_type=ZAP Scan" -F "file=@/home/jenkins/workspace/${JENKINS_PROJECT_NAME}/zap/zap_report.xml;type=text/xml" -F "engagement=${DEFECT_DOJO_ENGAGEMENT_ID}" -F "close_old_findings=false" -F "push_to_jira=false"'
        //stop test container
        sh 'docker container stop apptest'
      }
    }
  }
}